<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="Application">

  <!--
    NOTE: ƒê√¢y l√† SQL maps m·∫´u cho database LP_ApplicationSystem.
    B·∫°n c·∫ßn ƒëi·ªÅu ch·ªânh table name v√† column names theo c·∫•u tr√∫c th·ª±c t·∫ø c·ªßa database.

    C√°c b∆∞·ªõc customize:
    1. Ch·∫°y test ƒë·ªÉ xem danh s√°ch tables
    2. Thay ƒë·ªïi table name trong SQL
    3. Thay ƒë·ªïi column names cho ph√π h·ª£p
    4. Adjust model class (Models/Application.cs)
  -->

  <!-- Get all applications -->
  <select id="Application.GetAll" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    SELECT TOP 100
      Id,
      ApplicationName,
      Description,
      Version,
      CreatedDate,
      UpdatedDate,
      IsActive
    FROM Applications
    WHERE IsActive = 1
    ORDER BY ApplicationName
  </select>

  <!-- Get application by ID -->
  <select id="Application.GetById" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    SELECT
      Id,
      ApplicationName,
      Description,
      Version,
      CreatedDate,
      UpdatedDate,
      IsActive
    FROM Applications
    WHERE Id = @Id
  </select>

  <!-- Search applications by name -->
  <select id="Application.SearchByName" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    SELECT
      Id,
      ApplicationName,
      Description,
      Version,
      CreatedDate,
      UpdatedDate,
      IsActive
    FROM Applications
    WHERE ApplicationName LIKE @SearchTerm
      AND IsActive = 1
    ORDER BY ApplicationName
  </select>

  <!-- Insert new application -->
  <insert id="Application.Insert">
    INSERT INTO Applications (
      ApplicationName,
      Description,
      Version,
      CreatedDate,
      IsActive
    )
    VALUES (
      @ApplicationName,
      @Description,
      @Version,
      GETDATE(),
      1
    )
  </insert>

  <!-- Update application -->
  <update id="Application.Update">
    UPDATE Applications
    SET
      ApplicationName = @ApplicationName,
      Description = @Description,
      Version = @Version,
      UpdatedDate = GETDATE()
    WHERE Id = @Id
  </update>

  <!-- Soft delete -->
  <update id="Application.Delete">
    UPDATE Applications
    SET IsActive = 0, UpdatedDate = GETDATE()
    WHERE Id = @Id
  </update>

  <!-- Get active count -->
  <select id="Application.GetActiveCount" resultType="System.Int32">
    SELECT COUNT(*)
    FROM Applications
    WHERE IsActive = 1
  </select>

  <!--
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    CDATA EXAMPLES - S·ª≠ d·ª•ng CDATA cho queries c√≥ d·∫•u < > v√† &
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  -->

  <!-- Example 1: Query v·ªõi d·∫•u < v√† > - D√πng CDATA -->
  <select id="Application.GetByPriceRange" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    <![CDATA[
      SELECT
        Id,
        ApplicationName,
        Description,
        Version,
        CreatedDate,
        UpdatedDate,
        IsActive
      FROM Applications
      WHERE Price >= @MinPrice
        AND Price <= @MaxPrice
        AND IsActive = 1
      ORDER BY Price
    ]]>
  </select>

  <!-- Example 2: Query v·ªõi nhi·ªÅu ƒëi·ªÅu ki·ªán < v√† > - D√πng CDATA -->
  <select id="Application.GetByDateRange" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    <![CDATA[
      SELECT *
      FROM Applications
      WHERE CreatedDate >= @StartDate
        AND CreatedDate <= @EndDate
        AND (UpdatedDate IS NULL OR UpdatedDate < GETDATE())
        AND IsActive = 1
      ORDER BY CreatedDate DESC
    ]]>
  </select>

  <!-- Example 3: Query ph·ª©c t·∫°p v·ªõi CASE, <, >, v√† AND/OR - D√πng CDATA -->
  <select id="Application.GetFilteredApplications" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    <![CDATA[
      SELECT
        Id,
        ApplicationName,
        Description,
        Version,
        CreatedDate,
        UpdatedDate,
        IsActive,
        CASE
          WHEN CreatedDate >= DATEADD(day, -30, GETDATE()) THEN 'New'
          WHEN CreatedDate >= DATEADD(day, -90, GETDATE()) THEN 'Recent'
          ELSE 'Old'
        END AS AgeCategory
      FROM Applications
      WHERE IsActive = 1
        AND (
          (@MinVersion IS NULL OR Version >= @MinVersion)
          AND (@MaxVersion IS NULL OR Version <= @MaxVersion)
        )
        AND (
          (@SearchTerm IS NULL OR ApplicationName LIKE '%' + @SearchTerm + '%')
          OR (@SearchTerm IS NULL OR Description LIKE '%' + @SearchTerm + '%')
        )
      ORDER BY CreatedDate DESC
    ]]>
  </select>

  <!-- Example 4: Query v·ªõi NOT IN v√† subquery - D√πng CDATA -->
  <select id="Application.GetExcludingIds" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    <![CDATA[
      SELECT *
      FROM Applications
      WHERE Id NOT IN (
        SELECT ApplicationId
        FROM DisabledApplications
        WHERE DisabledDate > DATEADD(month, -3, GETDATE())
      )
      AND IsActive = 1
      ORDER BY ApplicationName
    ]]>
  </select>

  <!-- Example 5: Query v·ªõi COUNT, GROUP BY, HAVING - D√πng CDATA -->
  <select id="Application.GetStatsByVersion">
    <![CDATA[
      SELECT
        Version,
        COUNT(*) AS TotalCount,
        SUM(CASE WHEN IsActive = 1 THEN 1 ELSE 0 END) AS ActiveCount,
        MIN(CreatedDate) AS FirstCreated,
        MAX(UpdatedDate) AS LastUpdated
      FROM Applications
      WHERE Version IS NOT NULL
      GROUP BY Version
      HAVING COUNT(*) > @MinCount
      ORDER BY Version DESC
    ]]>
  </select>

  <!--
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    ALTERNATIVE: S·ª≠ d·ª•ng XML Entities thay v√¨ CDATA
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    N·∫øu kh√¥ng d√πng CDATA, b·∫°n ph·∫£i escape c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát:
    < (less than)       ‚Üí &lt;
    > (greater than)    ‚Üí &gt;
    & (ampersand)       ‚Üí &amp;
    " (quote)           ‚Üí &quot;
    ' (apostrophe)      ‚Üí &apos;
  -->

  <!-- Example 6: Query d√πng XML Entities (kh√¥ng d√πng CDATA) -->
  <select id="Application.GetByPriceRangeNoCD ATA" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    SELECT *
    FROM Applications
    WHERE Price &gt;= @MinPrice
      AND Price &lt;= @MaxPrice
      AND IsActive = 1
    ORDER BY Price
  </select>

  <!-- Example 7: Complex query v·ªõi XML Entities -->
  <select id="Application.GetRecentAppsNoCD ATA" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    SELECT *
    FROM Applications
    WHERE CreatedDate &gt;= @SinceDate
      AND (UpdatedDate IS NULL OR UpdatedDate &lt; GETDATE())
      AND IsActive = 1
    ORDER BY CreatedDate DESC
  </select>

  <!--
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    BEST PRACTICE: Khi n√†o d√πng CDATA?
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    ‚úÖ D√ôNG CDATA khi:
       - Query c√≥ nhi·ªÅu d·∫•u <, >, &
       - Complex queries v·ªõi CASE, subqueries
       - D·ªÖ ƒë·ªçc v√† maintain h∆°n

    ‚ùå KH√îNG D√ôNG CDATA khi:
       - Query ƒë∆°n gi·∫£n
       - Kh√¥ng c√≥ d·∫•u <, >, &
       - Mu·ªën XML editor validate syntax

    üìù L∆ØU √ù:
       - CDATA section b·∫Øt ƒë·∫ßu v·ªõi <![CDATA[
       - CDATA section k·∫øt th√∫c v·ªõi ]]>
       - Trong CDATA, XML kh√¥ng parse special characters
       - Indent code trong CDATA cho d·ªÖ ƒë·ªçc
  -->

  <!-- Example 8: Nested queries v√† complex conditions - D√πng CDATA -->
  <select id="Application.GetTopApplicationsWithDetails">
    <![CDATA[
      WITH ApplicationStats AS (
        SELECT
          a.Id,
          a.ApplicationName,
          a.Version,
          COUNT(u.UserId) AS UserCount,
          AVG(u.Rating) AS AvgRating
        FROM Applications a
        LEFT JOIN UserRatings u ON a.Id = u.ApplicationId
        WHERE a.IsActive = 1
          AND a.CreatedDate >= @SinceDate
        GROUP BY a.Id, a.ApplicationName, a.Version
        HAVING COUNT(u.UserId) > 0
      )
      SELECT TOP (@TopN)
        Id,
        ApplicationName,
        Version,
        UserCount,
        AvgRating,
        CASE
          WHEN AvgRating >= 4.5 THEN 'Excellent'
          WHEN AvgRating >= 3.5 THEN 'Good'
          WHEN AvgRating >= 2.5 THEN 'Average'
          ELSE 'Poor'
        END AS RatingCategory
      FROM ApplicationStats
      WHERE AvgRating > @MinRating
      ORDER BY AvgRating DESC, UserCount DESC
    ]]>
  </select>

  <!-- Example 9: Dynamic search v·ªõi multiple conditions - D√πng CDATA -->
  <select id="Application.DynamicSearch" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    <![CDATA[
      SELECT *
      FROM Applications
      WHERE IsActive = 1
        AND (@ApplicationName IS NULL OR ApplicationName LIKE '%' + @ApplicationName + '%')
        AND (@MinVersion IS NULL OR Version >= @MinVersion)
        AND (@MaxVersion IS NULL OR Version <= @MaxVersion)
        AND (@CreatedAfter IS NULL OR CreatedDate >= @CreatedAfter)
        AND (@CreatedBefore IS NULL OR CreatedDate <= @CreatedBefore)
        AND (@Description IS NULL OR Description LIKE '%' + @Description + '%')
      ORDER BY
        CASE WHEN @SortBy = 'Name' THEN ApplicationName END ASC,
        CASE WHEN @SortBy = 'Date' THEN CreatedDate END DESC,
        CASE WHEN @SortBy = 'Version' THEN Version END DESC,
        ApplicationName -- Default sort
    ]]>
  </select>

  <!-- Example 10: Query v·ªõi XML characters trong string values - D√πng CDATA -->
  <select id="Application.SearchSpecialChars" resultType="WSC.DataAccess.RealDB.Test.Models.Application">
    <![CDATA[
      SELECT *
      FROM Applications
      WHERE IsActive = 1
        AND (
          ApplicationName LIKE '%<xml>%'
          OR ApplicationName LIKE '%&%'
          OR Description LIKE '%<%'
          OR Description LIKE '%>%'
        )
      ORDER BY ApplicationName
    ]]>
  </select>

</sqlMap>
